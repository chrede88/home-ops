# Flux

The next thing to setup is [Fluxcd](https://fluxcd.io) or just Flux for short. By running Flux my git repository becomes the source of truth for my Kubernetes cluster. Any changes made to the manifests in the git repository is automatically reflected in the cluster. Pairing Flux with Renovate is potent combi!

## Setting up Flux
I'll use an ssh key to authenticate with Github. So first item on the agenda is generate a ssh key for Flux.

```zsh
ssh-keygen -t ed25519 -C "christian@cjsolsen.com"
```

Next I'll add the public key to the deploy keys my Github repository (the key needs push access).

Now I'm ready to bootstrap Flux :tada:

But first, let's use Flux to check if everything will work before running the real bootstrap.

```zsh
flux check --pre
```

Start the bootstrap when everything is good.

```zsh
flux bootstrap git \
  --url=ssh://git@github.com/chrede88/home-ops \
  --interval 30m \
  --branch=main \
  --private-key-file=/Users/cjso/.ssh/flux-key \
  --path=cluster/kubernetes
```

Flux will now install all the needed resources in a seperate namespace called `flux-system`.

It's a good idea to rotate the used authentication keys on a regular basis. This can be done with Flux.
1) Delete the secret in the `flux-system` namespace
2) Run the following command:
```zsh
flux create secret git flux-system \
  --url=ssh://git@github.com/chrede88/home-ops \
  --ssh-key-algorithm=ed25519
```

## SOPS & age
As the plan is publish everything about my cluster on Github, I need to encrypt the Kubernetes secrets. Even if one chooses a private Github repo I would still do it, just to be on the safe side.

First I've to install SOPS and age.
```zsh
brew install sops age
```

Next generate an age key to use for encryption/decryption:

```zsh
age-keygen -o flux.agekey
```

The key is stored in `~/.config/sops/age/flux.agekey`.
In order for Flux to be able to decrypt files we need to add a Kubernetes secret with the age key.

```zsh
cat flux.agekey |
kubectl create secret generic sops-age \
--namespace=flux-system \
--from-file=flux.agekey=/dev/stdin
```
Before encrypting this file, I'll setup a SOPS config file, so I don't have to apply the age public key everytime.

I've to add a file called `.sops.yaml` to the root of my repository, with the following content:

```yaml
creation_rules:
  - path_regex: cluster/talos/.*.ya?ml # Talos config
    input_type: yaml
    encrypted_regex: ^(token|crt|key|id|secret|secrets|secretboxEncryptionSecret|ca)$
    age: <age-public-key>
  - path_regex: cluster/kubernetes/.*.ya?ml # Kubernetes secrets
    input_type: yaml
    encrypted_regex: ^(data|stringData)$
    age: <age-public-key>
```

I would like to store the secret manifest in a yaml file so I can easily find it. We can retreive the secret using `kubectl`:

```zsh
kubectl get secret sops-age -n flux-system -o yaml > flux-system/config/sops-age.yaml
```

With this file I can now very easily encrypt the kubernetes secret I just created:

```zsh
sops -e -i sops-age.yaml
```

The `-e` flag means encrypt and `-i` means "in place". Use `-d` to decrypt a file.

### Patch gotk-sync.yaml
The last thing I need to do is to patch the autogenerated main cluster kustomization, by added the following yaml to the `spec` field.

```yaml
decryption:
  provider: sops
  secretRef:
    name: sops-age
```

This tells Flux to look in the `sops-age` secret for the decryption key.

## Setup Notifications/Alerts
Flux can push notification/alerts to a long list of different platforms. I'll setup a [Slack bot](https://api.slack.com/start/quickstart#creating) called `Flux`. Very original, I know...

I need the bot token so I can create a Kubernetes secret, as well as a flux notification provider and a Flux alert.
I'll add these files to each namespace I'll create, so Flux can send alerts for all reconcile errors.

```yaml
# notifications.yaml
---
apiVersion: notification.toolkit.fluxcd.io/v1beta3
kind: Provider
metadata:
  name: slack-bot
  namespace: <namespace>
spec:
  type: slack
  channel: flux-cd
  address: https://slack.com/api/chat.postMessage
  secretRef:
    name: slack-token
---
apiVersion: notification.toolkit.fluxcd.io/v1beta3
kind: Alert
metadata:
  name: slack
  namespace: <namespace>
spec:
  providerRef:
    name: slack-bot
  eventSeverity: error
  eventSources:
    - kind: GitRepository
      name: "*"
    - kind: HelmRelease
      name: "*"
    - kind: HelmRepository
      name: "*"
    - kind: Kustomization
      name: "*"
---
apiVersion: v1
kind: Secret
metadata:
  name: slack-token
  namespace: <namespace>
stringData:
  token: <bot-token>
```